<div class="ticket-container" *ngIf="ticket">
  <div class="glass-background"></div>
  
  <header class="ticket-section">
    <!-- Back button and navigation -->
    <div class="navigation-header">
      <button class="back-button" (click)="goBack()" matTooltip="Regresar">
        <mat-icon>arrow_back</mat-icon>
        <span>Regresar</span>
      </button>
    </div>

    <!-- Enhanced ticket header card -->
    <div class="ticket-header-card">
      <div class="ticket-title-section">
        <div class="ticket-title-content">
          <div class="ticket-number-badge">
            <mat-icon>confirmation_number</mat-icon>
            <span>#{{ticket.number}}</span>
          </div>
          <h1 class="ticket-title-text">{{ticket.title}}</h1>
          <div class="ticket-actions-header">
            <button class="button-share modern-button" (click)="sharePage()"
              matTooltip="Compartir detalles del ticket {{ticket.number}}">
              <mat-icon>share</mat-icon>
            </button>
            <button class="rate-button modern-button" (click)="openRateTicket(ticket)" *ngIf="openRate">
              <mat-icon>star_half</mat-icon>
              <span>Evaluar</span>
            </button>
          </div>
        </div>
        
        <!-- Status indicator -->
        <div class="status-indicator" [ngClass]="'status-' + ticket.status">
          <mat-icon>{{getStatusIcon(ticket.status)}}</mat-icon>
          <span>{{getStatusEn(ticket.status)}}</span>
        </div>
      </div>
    </div>

    <!-- Enhanced ticket details cards -->
    <div class="ticket-details-grid">
      <!-- Primary Information Card -->
      <div class="details-card primary-info">
        <div class="card-header">
          <mat-icon>info</mat-icon>
          <h3>Información Principal</h3>
        </div>
        <div class="card-content">
          <div class="detail-item">
            <div class="detail-icon">
              <mat-icon>person</mat-icon>
            </div>
            <div class="detail-content">
              <span class="detail-label">Autor</span>
              <span class="detail-value">{{ticket.owner.firstName}} {{ticket.owner.lastName}}</span>
            </div>
          </div>

          <div class="detail-item" *ngIf="ticket.assignedTo">
            <div class="detail-icon">
              <mat-icon>support_agent</mat-icon>
            </div>
            <div class="detail-content">
              <span class="detail-label">Agente Asignado</span>
              <span class="detail-value">{{ticket.assignedTo.firstName}} {{ticket.assignedTo.lastName}}</span>
            </div>
          </div>

          <div class="detail-item">
            <div class="detail-icon">
              <mat-icon>business</mat-icon>
            </div>
            <div class="detail-content">
              <span class="detail-label">Departamento</span>
              <span class="detail-value">{{ticket.department.name}}</span>
            </div>
          </div>

          <div class="detail-item">
            <div class="detail-icon">
              <mat-icon>help</mat-icon>
            </div>
            <div class="detail-content">
              <span class="detail-label">Tema de Ayuda</span>
              <span class="detail-value">{{ticket.helpTopic.name}}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Status and Timeline Card -->
      <div class="details-card status-info">
        <div class="card-header">
          <mat-icon>schedule</mat-icon>
          <h3>Estado y Tiempo</h3>
        </div>
        <div class="card-content">
          <div class="detail-item" *ngIf="notUser">
            <div class="detail-icon">
              <mat-icon>hourglass_empty</mat-icon>
            </div>
            <div class="detail-content">
              <span class="detail-label">Estado</span>
              <span class="detail-value status-badge" [ngClass]="getExpirationStatusClass(ticket, seconds2String(counter))">
                {{ getExpirationStatus(ticket, seconds2String(counter)) }}
              </span>
            </div>
          </div>

          <div class="detail-item" *ngIf="ticket.rating">
            <div class="detail-icon">
              <mat-icon>star</mat-icon>
            </div>
            <div class="detail-content">
              <span class="detail-label">Calificación</span>
              <span class="detail-value rating-badge" [ngClass]="getRatingClass(ticket.rating)">
                {{formatDecimal(ticket.rating)}} ⭐
              </span>
            </div>
          </div>

          <div class="detail-item" *ngIf="notUser">
            <div class="detail-icon">
              <mat-icon>timer</mat-icon>
            </div>
            <div class="detail-content">
              <span class="detail-label">Tiempo de Expiración</span>
              <span class="detail-value">{{minutes2String(ticket.helpTopic.expIn)}}</span>
            </div>
          </div>

          <div class="detail-item" *ngIf="notUser">
            <div class="detail-icon">
              <mat-icon>timer_off</mat-icon>
            </div>
            <div class="detail-content">
              <span class="detail-label">Expira en</span>
              <span class="detail-value countdown-timer">{{seconds2String(counter) || '00:00'}}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Timeline Card -->
      <div class="details-card timeline-info">
        <div class="card-header">
          <mat-icon>event</mat-icon>
          <h3>Cronología</h3>
        </div>
        <div class="card-content timeline-content">
          <div class="timeline-item" *ngIf="ticket.createdAt">
            <div class="timeline-icon created">
              <mat-icon>add_circle</mat-icon>
            </div>
            <div class="timeline-content-item">
              <span class="timeline-label">Creado</span>
              <span class="timeline-date">{{formatLocalDateL(ticket.createdAt, dateTypeL.long)}}</span>
            </div>
          </div>

          <div class="timeline-item" *ngIf="ticket.assignedAt">
            <div class="timeline-icon assigned">
              <mat-icon>assignment_ind</mat-icon>
            </div>
            <div class="timeline-content-item">
              <span class="timeline-label">Asignado</span>
              <span class="timeline-date">{{formatLocalDateL(ticket.assignedAt, dateTypeL.long)}}</span>
            </div>
          </div>

          <div class="timeline-item" *ngIf="ticket.completedAt">
            <div class="timeline-icon completed">
              <mat-icon>check_circle</mat-icon>
            </div>
            <div class="timeline-content-item">
              <span class="timeline-label">Completado</span>
              <span class="timeline-date">{{formatLocalDateL(ticket.completedAt, dateTypeL.long)}}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced description section -->
    <div class="description-card">
      <div class="card-header">
        <mat-icon>description</mat-icon>
        <h3>Descripción del Ticket</h3>
      </div>
      <div class="description-content">
        <p>{{ticket.description}}</p>
      </div>
    </div>
  </header>

  <main class="ticket-section">
    <!-- Enhanced chat container -->
    <div class="chat-section" 
      *ngIf="!(messages.length === 0 && (ticket.status === status.CLOSED || ticket.status === status.CANCELED))">
      <div class="chat-header">
        <mat-icon>chat</mat-icon>
        <h3>Conversación del Ticket</h3>
        <div class="message-count-badge">{{messages.length}} mensajes</div>
      </div>
      
      <div #chatContainer class="chat-container">
        <div class="message-container modern-message" [ngClass]="message.attachment && 'max-width-file'" [ngClass]="ticketOwner(message)"
          *ngFor="let message of messages; trackBy: trackByMessageId">

          <div class="message-header">
            <div class="message-author-info">
              <div class="author-avatar">
                <mat-icon>person</mat-icon>
              </div>
              <div class="author-details">
                <p class="message-author">{{message.owner.firstName}} {{message.owner.lastName}}</p>
                <p class="message-time">{{formatLocalDateL(message.createdAt || '', dateTypeL.short)}}</p>
              </div>
            </div>

            <button class="message-menu modern-menu-button" [matMenuTriggerFor]="menu" aria-label="Message Menu"
              *ngIf="(itsMyMessage(message) && message.visibility !== messageVisibilities.TO_NO_ONE) || isAdmin">
              <mat-icon>{{getVisibilityIcon(message.visibility)}}</mat-icon>
            </button>

            <mat-menu #menu="matMenu">
              <button mat-menu-item (click)="changeVisibility(message._id, messageVisibilities.TO_ALL)">
                <mat-icon>{{getVisibilityIcon(messageVisibilities.TO_ALL)}}</mat-icon>
                <span>Ver para todos</span>
              </button>

              <button mat-menu-item *ngIf="userRol !== roles.USER"
                (click)="changeVisibility(message._id, messageVisibilities.TO_AGENTS)">
                <mat-icon>{{getVisibilityIcon(messageVisibilities.TO_AGENTS)}}</mat-icon>
                <span>Solo para uso interno</span>
              </button>

              <button mat-menu-item (click)="changeVisibility(message._id, messageVisibilities.ONLY_TO_ME)">
                <mat-icon>{{getVisibilityIcon(messageVisibilities.ONLY_TO_ME)}}</mat-icon>
                <span>Solo para mi</span>
              </button>

              <button mat-menu-item *ngIf="message.visibility !== messageVisibilities.TO_NO_ONE || isAdmin"
                (click)="changeVisibility(message._id, messageVisibilities.TO_NO_ONE)">
                <mat-icon>{{getVisibilityIcon(messageVisibilities.TO_NO_ONE)}}</mat-icon>
                <span>Eliminar mensaje</span>
              </button>
            </mat-menu>
          </div>

          <!-- Message content with enhanced styling -->
          <div class="message-content">
            <img class="message-img" [src]="getMediaUrl(message)" *ngIf="
                            message.attachmentType === messageAttachmentType.IMAGE &&
                            message.visibility !== messageVisibilities.TO_NO_ONE
                        " alt="Imagen del mensaje" (click)="openViewImage(getMediaUrl(message))">

            <video class="message-video" [src]="getMediaUrl(message)" *ngIf="
                            message.attachmentType === messageAttachmentType.VIDEO &&
                            message.visibility !== messageVisibilities.TO_NO_ONE
                        " controls></video>

            <button class="message-other modern-file-button" [ngClass]="fileOwner(message)" type="button" (click)="downloadFile(message)"
              *ngIf="
                            (message.attachmentType === messageAttachmentType.OTHER ||
                            message.attachmentType === messageAttachmentType.TEXT ||
                            message.attachmentType === messageAttachmentType.PDF) &&
                            message.visibility !== messageVisibilities.TO_NO_ONE
                            ">
              <div class="preview-other-item">
                <mat-icon>download</mat-icon>
                <h4 matTooltip="{{message.attachment.originalName}}">{{ formatFileName(message.attachment.originalName ||
                  'Unnamed', 20) }}</h4>
              </div>
            </button>

            
            <p class="message-text" *ngIf="message.visibility !== messageVisibilities.TO_NO_ONE">
              <span [innerHTML]="getTruncatedText(message)"></span>
              <span *ngIf="message.text.length > maxLength" (click)="toggleExpand(message)" class="read-more-button">
                <span
                  [innerHTML]="isMessageExpanded(message) ? '<strong> \n\n Leer menos</strong>' : '<strong> Leer más</strong>'"></span>
              </span>
            </p>

            <p class="message-text deleted-message" *ngIf="message.visibility === messageVisibilities.TO_NO_ONE">
              <mat-icon>delete</mat-icon>
              Mensaje Eliminado
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- File viewer section -->
    <div class="file-viewer" *ngIf="getOpenInputFile()">
      <button class="delete-file" matTooltip="Eliminar Archivo" (click)="resetFileSelect(true)">
        <mat-icon>delete</mat-icon>
      </button>
    
      <img class="preview-image" *ngIf="isImage" [src]="previewUrl" alt="Vista previa de Imagen"
        (click)="openViewImage(previewUrl)" />
    
      <video class="preview-video" *ngIf="isVideo" [src]="previewUrl" controls></video>
    
      <div class="preview-txt" *ngIf="isText">
        <p>{{ previewText }}</p>
      </div>
    
      <iframe class="preview-pdf" *ngIf="isPdf" [src]="previewUrl"></iframe>
    
      <a class="preview-other" *ngIf="isOther" [href]="previewUrl" target="_blank" download="{{messageFile?.name}}">
        <div class="preview-other-item">
          <h3>{{ formatFileName(messageFile?.name || '', 30) }}</h3>
          <mat-icon>download</mat-icon>
        </div>
      </a>
    </div>

    <!-- Enhanced message form -->
    <form #sendMessageContainer class="send-message-container modern-form" action="" (ngSubmit)="sendMessage($event)"
      [formGroup]="formMessage" autocomplete="off" *ngIf="unassignedOrAdmin">

      <div class="container-message" (drop)="onDrop($event)" (dragover)="onDragOver($event)" (paste)="onPaste($event)">
        <textarea class="input-message" formControlName="message" rows="3" (keydown)="onKeyDown($event)"
          placeholder="Escribe un mensaje...">
        </textarea>

        <input type="file" class="input-message-file" #fileInput (change)="onFileSelectedInput($event)" accept="image/*"
          hidden>
      </div>

      <div class="button-container">
        <button class="button-send" type="button" matTooltip="Adjuntar Archivo" id="fileButton"
          (click)="triggerFileInput()">
          <mat-icon class="hover-fill">attach_file</mat-icon>
          <input type="file" class="fileInput" id="fileInput" style="display: none;" (change)="onFileSelected($event)">
        </button>

        <button class="message-menu button-send" type="button" matTooltip="Cambiar visiblidad"
          [matMenuTriggerFor]="menu" aria-label="Message Menu">
          <mat-icon>{{getVisibilityIcon(messageVisibility)}}</mat-icon>
        </button>

        <mat-menu #menu="matMenu">
          <button mat-menu-item (click)="selectMessageVisibility(messageVisibilities.TO_ALL)">
            <mat-icon>{{getVisibilityIcon(messageVisibilities.TO_ALL)}}</mat-icon>
            <span>Ver para todos</span>
          </button>

          <button mat-menu-item *ngIf="userRol !== roles.USER"
            (click)="selectMessageVisibility(messageVisibilities.TO_AGENTS)">
            <mat-icon>{{getVisibilityIcon(messageVisibilities.TO_AGENTS)}}</mat-icon>
            <span>Solo para uso interno</span>
          </button>

          <button mat-menu-item (click)="selectMessageVisibility(messageVisibilities.ONLY_TO_ME)">
            <mat-icon>{{getVisibilityIcon(messageVisibilities.ONLY_TO_ME)}}</mat-icon>
            <span>Solo para mi</span>
          </button>
        </mat-menu>

        <button class="button-send" type="submit" matTooltip="Enviar mensaje" [disabled]="formMessage.invalid">
          <mat-icon class="hover-fill">send</mat-icon>
        </button>
      </div>
    </form>
  </main>

  <footer class="ticket-section" *ngIf="visiblePanel">
    <div class="actions-dropdown-container">
      <h3 class="actions-title">Panel de Acciones</h3>
      <button class="actions-dropdown-trigger" [matMenuTriggerFor]="actionsMenu" mat-raised-button>
        <mat-icon class="actions-icon">settings</mat-icon>
        <span class="actions-text">Gestionar Ticket</span>
        <mat-icon class="dropdown-arrow">expand_more</mat-icon>
      </button>

      <mat-menu #actionsMenu="matMenu" class="actions-dropdown-menu" xPosition="before" yPosition="above">
        <button mat-menu-item (click)="openAssignedAgent(ticket)" class="menu-item-assign">
          <div class="menu-item-content">
            <mat-icon>person_add</mat-icon>
            <div class="menu-item-text">
              <span class="menu-item-title">Asignar Agente</span>
              <span class="menu-item-subtitle">Asignar responsable del ticket</span>
            </div>
          </div>
        </button>

        <button mat-menu-item (click)="openTransferTicket(ticket)" class="menu-item-transfer">
          <div class="menu-item-content">
            <mat-icon>swap_horiz</mat-icon>
            <div class="menu-item-text">
              <span class="menu-item-title">Transferir Ticket</span>
              <span class="menu-item-subtitle">Mover a otro departamento</span>
            </div>
          </div>
        </button>

        <button mat-menu-item (click)="openChangeStatus(ticket)" *ngIf="unassignedOrAdmin" class="menu-item-status">
          <div class="menu-item-content">
            <mat-icon>update</mat-icon>
            <div class="menu-item-text">
              <span class="menu-item-title">Cambiar Estatus</span>
              <span class="menu-item-subtitle">Actualizar estado del ticket</span>
            </div>
          </div>
        </button>
      </mat-menu>
    </div>
  </footer>
</div>


<div class="loader-container" *ngIf="!loaded">
  <span class="loader"></span>
</div>


<h1 *ngIf="!ticket && loaded">
  Ticket no encontrado...
</h1>